<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER SOL - í”„ë¡œí† íƒ€ì…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN (corrected integrity attribute) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior-y: contain; 
        }
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shinhan-dark-blue': '#004098',
                        'shinhan-blue': '#0072CE',
                        'shinhan-light-blue': '#E6F2FF',
                        'shinhan-gray': '#F5F7FA',
                        'shinhan-dark-gray': '#2E3A59',
                    }
                }
            }
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            width: 100%;
            background-color: white; 
            height: 100vh; /* Ensure pages take full viewport height */
            flex-direction: column; /* Default to column for page content */
        }
        .page.active {
            display: flex; 
        }
        /* page-main and page-chat need space for bottom nav */
        #page-main.active, #page-chat.active {
            height: calc(100vh - 4rem); /* Adjust height considering bottom nav */
            overflow-y: auto;
        }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cover-gradient {
            background: linear-gradient(to bottom right, #004098, #005cb9);
            /* min-height: 100vh; */
            position: absolute; top:0; left:0; 
        }
        .search-bar-shadow {
            box-shadow: 0 4px 12px rgba(0, 114, 206, 0.2);
        }
        .chat-bubble {
            animation: slideUp 0.3s ease-out;
            max-width: 80%; 
        }
        .chat-bubble-user {
            background-color: #0072CE; 
            color: white;
        }
        .chat-bubble-bot {
            background-color: #E6F2FF; 
            color: #2E3A59; 
        }
        .chat-bubble-bot table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .chat-bubble-bot th, .chat-bubble-bot td {
            border: 1px solid #cccccc;
            padding: 6px 10px;
            text-align: left;
        }
        .chat-bubble-bot th {
            background-color: #f0f0f0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0072CE;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .quick-reply-button {
            background-color: #0072CE;
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            margin: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quick-reply-button:hover {
            background-color: #005cb9;
        }
        #page-main {
            padding-bottom: 1rem; 
        }
        #transfer-chat-messages {
            min-height: 450px; 
        }
        #chat-messages-container { /* For SOLbot chat */
             flex-grow: 1;
             overflow-y: auto;
             padding: 1rem;
        }
        #solbot-input-container { /* For SOLbot chat */
            background-color: white;
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb; /* Tailwind gray-200 */
        }

    </style>
</head>
<body class="bg-white overflow-hidden"> 

    <div id="loading-indicator" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <!-- í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container" class="relative w-full max-w-md mx-auto h-screen overflow-hidden border border-gray-300 rounded-lg shadow-xl">

        <!-- Page 1: Cover -->
        <div id="page-cover" class="page active cover-gradient items-center justify-center p-8 text-white text-center">
            <div class="text-5xl font-bold mb-4">
                <i class="fas fa-bolt-lightning"></i> SOL
            </div>
            <h1 class="text-3xl font-bold mb-2">SUPER SOL</h1>
            <p class="text-lg mb-8">"ë§í•˜ë©´ ë‹¤ ë˜ëŠ” ë˜‘ë˜‘í•œ ê¸ˆìœµ ìƒí™œ"</p>
            <div class="w-full max-w-sm mt-8">
                <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="cover-search-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleCoverSearch(event)">
                    <button onclick="handleCoverSearch(null, false, true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="handleCoverSearch(null, true, false)" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">ë§í•˜ê¸°</span>
                    </button>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-200">ì˜ˆ: "ì†¡ê¸ˆ", "ê³„ì¢Œ ì¡°íšŒ"</p>
             <button onclick="showPage('page-main')" class="mt-8 text-gray-300 hover:text-white underline">
                ë˜ëŠ”, ë‘˜ëŸ¬ë³´ê¸°
            </button>
        </div>

        <!-- Page 2: Main UI -->
        <div id="page-main" class="page bg-white no-scrollbar"> 
            <!-- ê²€ìƒ‰ë°” (Main) -->
            <div class="p-4 sticky top-0 bg-white z-10">
                 <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="main-search-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleMainSearch(event)">
                     <button onclick="handleMainSearch(null, false, true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="handleMainSearch(null, true, false)" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">ë§í•˜ê¸°</span>
                    </button>
                </div>
            </div>
            <!-- ì¶”ì²œ ì„œë¹„ìŠ¤ (Main) -->
            <div class="p-4 space-y-3">
                <h2 class="text-lg font-semibold text-shinhan-dark-gray mb-3 px-2">ì¶”ì²œ ì„œë¹„ìŠ¤</h2>
                <div onclick="showService('ì”ì•¡ì¡°íšŒ')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ’° ì”ì•¡ì¡°íšŒ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="goToTransferFromMainUI()" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ’¸ ì†¡ê¸ˆ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="showService('íˆ¬ì ì¶”ì²œ')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ“ˆ íˆ¬ì ì¶”ì²œ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="showService('í™˜ìœ¨ ì •ë³´')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸŒ í™˜ìœ¨ ì •ë³´</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="getFinancialTip()" class="bg-shinhan-light-blue hover:bg-blue-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all mt-4">
                    <span class="text-shinhan-blue font-semibold text-md">âœ¨ ì˜¤ëŠ˜ì˜ AI ê¸ˆìœµ íŒ</span>
                    <i class="fas fa-lightbulb text-shinhan-blue"></i>
                </div>
            </div>
            <!-- SOLbot section removed from here -->
             <div class="h-16"></div> 
        </div>


        <!-- Page 3: Search Results -->
        <div id="page-search-results" class="page bg-white"> 
             <div class="w-full h-full bg-white z-20 flex flex-col"> 
                <div class="p-4 sticky top-0 bg-white z-10 border-b">
                    <button onclick="showPage('page-main');" class="text-shinhan-blue absolute top-1/2 left-4 transform -translate-y-1/2">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-shinhan-dark-gray text-center py-3">ê²€ìƒ‰ ê²°ê³¼</h2>
                </div>
                <div class="p-4 flex-grow overflow-y-auto no-scrollbar">
                    <p class="text-sm text-center text-shinhan-blue mb-4">âœ¨ AIê°€ ì¶”ì²œí•˜ëŠ” ê²°ê³¼ì…ë‹ˆë‹¤ âœ¨</p>
                    <div class="space-y-3" id="search-results-content">
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: SOLbot Chat (Restored as a separate page) -->
        <div id="page-chat" class="page bg-gray-100">
            <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                <button onclick="showPage('page-main')" class="text-shinhan-blue mr-3">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                    <i class="fas fa-robot"></i>
                </div>
                <h2 class="text-xl font-semibold text-shinhan-dark-gray">SOLë´‡</h2>
            </div>
            <div id="chat-messages-container" class="no-scrollbar">
                <div id="chat-messages" class="p-4 space-y-4"> 
                    <!-- Initial SOLbot welcome message will be added by JS -->
                </div>
            </div>
            <div id="solbot-input-container" class="flex-shrink-0"> 
                <div class="flex items-center bg-gray-100 rounded-full p-1">
                    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§í•´ì£¼ì„¸ìš”" class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500" onkeypress="handleChatInput(event)">
                    <button onclick="sendChatMessage(null, true)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                     <button onclick="sendChatMessage(document.getElementById('chat-input').value, false)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </div>
        </div>


        <!-- Page 5: Transfer (ì±„íŒ…í˜• ì†¡ê¸ˆ) -->
        <div id="page-transfer" class="page bg-gray-100"> 
            <div class="w-full h-full bg-gray-100 z-20 flex flex-col"> 
                <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                    <button onclick="cancelTransferAndGoBack()" class="text-shinhan-blue mr-3">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                        <i class="fas fa-comments-dollar"></i> 
                    </div>
                    <h2 class="text-xl font-semibold text-shinhan-dark-gray">ì†¡ê¸ˆí•˜ê¸°</h2>
                </div>
                <div id="transfer-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto no-scrollbar">
                    {/* ì†¡ê¸ˆ ì±—ë´‡ ë©”ì‹œì§€ */}
                </div>
                 <div id="transfer-summary-display" class="p-4 bg-white border-t flex-shrink-0" style="display:none;">
                    <h3 class="text-md font-semibold text-shinhan-dark-gray mb-2 text-center">âœ¨ AI ì´ì²´ë‚´ì—­ ìš”ì•½ âœ¨</h3>
                    <div id="ai-transfer-summary-text" class="bg-shinhan-light-blue text-shinhan-dark-gray p-3 rounded-lg shadow text-sm mb-3 text-left">
                        {/* AI ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë¨ */}
                    </div>
                    <button onclick="resetAndGoBackFromTransfer()" class="w-full bg-shinhan-blue hover:bg-shinhan-dark-blue text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">
                        í™•ì¸
                    </button>
                </div>
                <div id="transfer-input-area" class="bg-white p-3 border-t flex-shrink-0"> 
                    <div class="flex items-center bg-gray-100 rounded-full p-1">
                        <input type="text" id="transfer-chat-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500">
                        <button onclick="handleTransferChatInput(true)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                     <div id="transfer-quick-reply-area" class="flex flex-wrap justify-center mt-2">
                        {/* ë¹ ë¥¸ ì‘ë‹µ ë²„íŠ¼ */}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ -->
        <div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-2 flex justify-around items-center h-16 z-30">
             <button onclick="showPage('page-cover')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center">
                <i class="fas fa-sign-out-alt text-xl"></i> <span class="text-xs">ì²«í™”ë©´</span>
            </button>
            <button onclick="showPage('page-main')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center" id="nav-home-button">
                <i class="fas fa-home text-xl"></i> <span class="text-xs">í™ˆ</span>
            </button>
            <button onclick="showPage('page-chat')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center" id="nav-solbot-button">
                <i class="fas fa-robot text-xl"></i> <span class="text-xs">SOLë´‡</span>
            </button>
            <button onclick="showToast('ì „ì²´ë©”ë‰´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center">
                <i class="fas fa-bars text-xl"></i> <span class="text-xs">ì „ì²´ë©”ë‰´</span>
            </button>
        </div>

    </div>

    <div id="toast-message" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        ë©”ì‹œì§€ ë‚´ìš©
    </div>

    <script>
        let currentPage = 'page-cover';
        let previousPageForTransfer = 'page-main'; // Default to main if transfer initiated weirdly
        let initialSolbotQuery = null; // To pass initial query from main search to SOLbot
        
        const GEMINI_API_KEY = "AIzaSyDfghlU_a0nTRFDOdDYampJl8XQdXh4_zQ"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        let currentTransferStep = ''; 
        let transferData = { recipient: '', amount: '', account: '' };
        const availableAccounts = [ 
            { name: "ì‹ í•œ ì£¼ê±°ë˜ ìš°ëŒ€í†µì¥", number: "110-***-123456" },
            { name: "ì í¸í•œ ì…ì¶œê¸ˆí†µì¥", number: "123-***-789012" },
            { name: "MY ê¸‰ì—¬í†µì¥", number: "456-***-789000" }
        ];

        async function callGeminiAPI(prompt, forChat = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    if (forChat) { 
                         throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                    }
                    return null; 
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:", result);
                    if (forChat) return "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ë‹µë³€ì„ ë“œë¦¬ê¸° ì–´ë µë„¤ìš”.";
                    return null; 
                }
            } catch (error) {
                console.error('Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                 if (forChat) showToast(`ì˜¤ë¥˜: ${error.message.substring(0,100)}`); 
                return forChat ? "ì£„ì†¡í•´ìš”, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”." : null; 
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        function updateActiveNavButton() {
            const homeButton = document.getElementById('nav-home-button');
            const solbotButton = document.getElementById('nav-solbot-button');
            
            [homeButton, solbotButton].forEach(btn => {
                if(btn) {
                    btn.classList.remove('text-shinhan-blue', 'font-semibold');
                    btn.classList.add('text-gray-500');
                }
            });

            if (currentPage === 'page-main' ) {
                 if(homeButton) {
                    homeButton.classList.add('text-shinhan-blue', 'font-semibold');
                    homeButton.classList.remove('text-gray-500');
                 }
            } else if (currentPage === 'page-chat') {
                if(solbotButton) {
                    solbotButton.classList.add('text-shinhan-blue', 'font-semibold');
                    solbotButton.classList.remove('text-gray-500');
                }
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            const bottomNav = document.getElementById('bottom-navigation');

            if (target) {
                target.classList.add('active');
                currentPage = pageId; // Update currentPage immediately

                if (pageId === 'page-main' || pageId === 'page-chat') {
                    if(bottomNav) bottomNav.style.display = 'flex';
                    target.style.position = 'relative'; // Ensure it's part of the flow
                    target.style.height = 'calc(100vh - 4rem)'; // Space for bottom nav
                    target.scrollTop = 0; // Scroll to top for these pages
                } else { // Overlay pages like cover, search-results, transfer
                    if(bottomNav) bottomNav.style.display = 'none';
                    target.style.position = 'absolute';
                    target.style.top = '0';
                    target.style.left = '0';
                    target.style.height = '100vh'; // Full height for overlays
                    target.style.zIndex = '20'; 
                }
                updateActiveNavButton(); // Update nav button based on the new currentPage


                if (pageId === 'page-transfer') {
                    startTransferChat(); 
                } else if (pageId === 'page-chat') {
                    initializeSolbotChat();
                } else if (['page-search-results'].includes(pageId)) {
                     target.querySelector('.overflow-y-auto')?.scrollTo(0,0);
                }
            }
        }
        
        function initializeSolbotChat() {
            const chatMessagesArea = document.getElementById('chat-messages');
            // Clear previous messages except for a new welcome message if it's a fresh load
            if (chatMessagesArea) {
                 chatMessagesArea.innerHTML = ''; // Clear old messages
                 addMessageToChat("AI", "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” SUPER SOLì˜ AI ë¹„ì„œ SOLë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?", 'chat-messages', 'chat-bubble-bot');
            }

            if (initialSolbotQuery) {
                sendChatMessage(initialSolbotQuery, false, true); // Send initial query if present
                initialSolbotQuery = null; // Clear after use
            }
        }


        function handleCoverSearch(event, isVoice = false, isSearchIcon = false) {
            const input = document.getElementById('cover-search-input');
            const query = input ? input.value.trim().toLowerCase() : "";
            let executeAction = false;

            if (event && event.key === 'Enter' && query) executeAction = true;
            else if (isSearchIcon && query) executeAction = true;
            else if (isVoice && query) executeAction = true; 
            else if (isVoice && !query) { 
                 showToast("ìŒì„±ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”. ì˜ˆ: 'OOOì—ê²Œ ì†¡ê¸ˆ'");
                 return;
            } else if ((event && event.key === 'Enter' && !query) || (isSearchIcon && !query)) {
                 showToast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                 return;
            }
            
            if (executeAction) {
                previousPageForTransfer = 'page-cover'; 
                if (query.includes("ì†¡ê¸ˆ") || query.includes("ë³´ë‚´ì¤˜") || query.includes("ì´ì²´")) {
                    showToast(`'${escapeHTML(query)}' ìš”ì²­ í™•ì¸. ì†¡ê¸ˆ ì„œë¹„ìŠ¤ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.`);
                    setTimeout(() => { showPage('page-transfer'); if(input) input.value = ""; }, 500);
                } else {
                    showToast(`'${escapeHTML(query)}'ì— ëŒ€í•´ SOLë´‡ì—ê²Œ ë¬¼ì–´ë³¼ê²Œìš”.`);
                    initialSolbotQuery = query;
                    setTimeout(() => { showPage('page-chat'); if(input) input.value = ""; }, 500);
                }
            }
        }

        function handleMainSearch(event, isVoice = false, isSearchIcon = false) {
            const input = document.getElementById('main-search-input');
            const query = input ? input.value.trim().toLowerCase() : "";
            let performAction = false;

            if (isVoice && query) performAction = true;
            else if (isVoice && !query) {
                showToast("ìŒì„±ìœ¼ë¡œ 'ì†¡ê¸ˆ' ë˜ëŠ” ê²€ìƒ‰ì–´ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”. SOLë´‡ì—ê²Œ ì§ì ‘ ë¬¼ì–´ë³´ì„¸ìš”!");
                // For voice without query, directly go to SOLbot page maybe? Or keep current page.
                // For now, just a toast. Could also call showPage('page-chat');
                return;
            }
            else if (event && event.key === 'Enter' && query) performAction = true;
            else if (isSearchIcon && query) performAction = true;
            else if (((event && event.key === 'Enter') || isSearchIcon) && !query) {
                 showToast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                 return;
            }

            if (performAction) {
                previousPageForTransfer = 'page-main'; // Set context for transfer page
                if (query.includes("ì†¡ê¸ˆ") || query.includes("ë³´ë‚´ì¤˜") || query.includes("ì´ì²´")) {
                    showToast(`'${escapeHTML(query)}' ìš”ì²­ í™•ì¸. ì†¡ê¸ˆ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                    setTimeout(() => {
                        showPage('page-transfer');
                        if(input) input.value = "";
                    }, 500);
                } else if (query) { 
                    showToast(`'${escapeHTML(query)}'ì— ëŒ€í•´ SOLë´‡ì—ê²Œ ë¬¼ì–´ë³¼ê²Œìš”.`);
                    initialSolbotQuery = query; // Pass query to SOLbot page
                    setTimeout(() => { 
                        showPage('page-chat');
                        if(input) input.value = "";
                    }, 500); 
                }
            }
        }
        
        async function getFinancialTip() {
            showToast("âœ¨ AIê°€ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ íŒì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...");
            const prompt = "ì¼ë°˜ì ì¸ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì§§ê³  ì‹¤ìš©ì ì¸ ê¸ˆìœµ íŒ í•˜ë‚˜ë§Œ í•œêµ­ì–´ë¡œ ì•Œë ¤ì¤˜. ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•´ì„œ ì¹œê·¼í•˜ê²Œ í‘œí˜„í•´ì¤˜.";
            const tip = await callGeminiAPI(prompt);
            if (tip) { 
                showToast(marked.parse(tip), 5000); 
            } else { 
                showToast("ê¸ˆìœµ íŒì„ ê°€ì ¸ì˜¤ëŠ”ë° ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜¥");
            }
        }

        function goToTransferFromMainUI() {
            previousPageForTransfer = 'page-main';
            showPage('page-transfer');
        }
        
        function handleChatInput(event) { 
            if (event.key === 'Enter') {
                sendChatMessage(document.getElementById('chat-input').value, false);
            }
        }
        
        async function sendChatMessage(message, isVoice = false, isInitialQuery = false) { 
            const chatInput = document.getElementById('chat-input'); // Assuming this is for SOLbot chat page
            const messageText = (typeof message === 'string' ? message.trim() : (chatInput ? chatInput.value.trim() : ""));
            let userPrompt = messageText;

            if (isVoice && !messageText && !isInitialQuery) {
                userPrompt = "ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•©ë‹ˆë‹¤: (ì‚¬ìš©ìê°€ ë§í•˜ëŠ” ì¤‘...)"; 
                showToast("ìŒì„± ì¸ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤..."); 
            }
            if (!userPrompt && !isInitialQuery) { // Allow empty initial query if page loaded with it
                 showToast("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (userPrompt) { // Only add user message if there is a prompt
                addMessageToChat("user", userPrompt, 'chat-messages', 'chat-bubble-user');
            }
            if(chatInput && !isInitialQuery) chatInput.value = ''; // Don't clear if it's an initial query that auto-sent

            // Use the original userPrompt (which might be from initialSolbotQuery)
            const aiResponseText = await callGeminiAPI(userPrompt || "ì•ˆë…•í•˜ì„¸ìš”.", true); // Send "ì•ˆë…•í•˜ì„¸ìš”" if prompt is empty after all
            addMessageToChat("AI", aiResponseText, 'chat-messages', 'chat-bubble-bot');
        }

        function addMessageToChat(sender, text, messageAreaId, bubbleClass) {
            const messagesArea = document.getElementById(messageAreaId);
            if(!messagesArea) return; 
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full`; 
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-lg shadow chat-bubble ${bubbleClass}`;
            
            if (sender === 'AI' && typeof marked !== 'undefined' && text) {
                bubbleDiv.innerHTML = marked.parse(text); 
            } else if (text) {
                bubbleDiv.textContent = text; 
            } else {
                bubbleDiv.textContent = ""; 
            }
            
            messageDiv.appendChild(bubbleDiv);
            messagesArea.appendChild(messageDiv);
            // Ensure the parent container (#chat-messages-container) is scrolled, not just the inner div
            const container = document.getElementById('chat-messages-container');
            if(container) container.scrollTop = container.scrollHeight;
            else messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function startTransferChat() {
            document.getElementById('transfer-chat-messages').innerHTML = ''; 
            document.getElementById('transfer-summary-display').style.display = 'none'; 
            document.getElementById('transfer-input-area').style.display = 'block'; 
            document.getElementById('transfer-chat-input').disabled = false;

            transferData = { recipient: '', amount: '', account: '' }; 
            currentTransferStep = 'recipient';
            addMessageToChat('bot', 'ëˆ„êµ¬ì—ê²Œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ? ê³„ì¢Œë²ˆí˜¸ë‚˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'transfer-chat-messages', 'chat-bubble-bot');
            clearQuickReplies();
            document.getElementById('transfer-chat-input').placeholder = 'ë°›ëŠ” ë¶„ ì…ë ¥...';
            document.getElementById('transfer-chat-input').type = 'text';
        }

        function handleTransferChatInput(isSendButton = false, quickReplyValue = null) {
            const input = document.getElementById('transfer-chat-input');
            const userText = quickReplyValue !== null ? quickReplyValue : (input ? input.value.trim() : "");

            if (!userText) {
                showToast("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            addMessageToChat('user', userText, 'transfer-chat-messages', 'chat-bubble-user');
            if(input) input.value = ''; 
            clearQuickReplies(); 

            setTimeout(() => { 
                processTransferStep(userText);
            }, 300);
        }

        function processTransferStep(userData) {
            switch(currentTransferStep) {
                case 'recipient':
                    transferData.recipient = userData;
                    currentTransferStep = 'amount';
                    addMessageToChat('bot', `ë„¤, ${escapeHTML(transferData.recipient)}ë‹˜ì—ê²Œ ë³´ë‚´ì‹œëŠ”êµ°ìš”. ì–¼ë§ˆë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ«ìë§Œ ì…ë ¥)`, 'transfer-chat-messages', 'chat-bubble-bot');
                    document.getElementById('transfer-chat-input').type = 'number'; 
                    document.getElementById('transfer-chat-input').placeholder = 'ê¸ˆì•¡(ìˆ«ì) ì…ë ¥...';
                    break;
                case 'amount':
                    if (!isNaN(parseFloat(userData)) && isFinite(userData) && parseFloat(userData) > 0) {
                        transferData.amount = parseFloat(userData);
                        currentTransferStep = 'account';
                        addMessageToChat('bot', `${escapeHTML(transferData.amount.toLocaleString())}ì›ì„ ë³´ë‚´ì‹œëŠ”êµ°ìš”. ì–´ë–¤ ê³„ì¢Œì—ì„œ ì¶œê¸ˆí• ê¹Œìš”? ì•„ë˜ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'transfer-chat-messages', 'chat-bubble-bot');
                        document.getElementById('transfer-chat-input').type = 'text';
                        document.getElementById('transfer-chat-input').placeholder = 'ê³„ì¢Œ ë³„ì¹­ ë˜ëŠ” ì„ íƒ...';
                        showAccountQuickReplies();
                    } else {
                         addMessageToChat('bot', 'ê¸ˆì•¡ì€ 0ë³´ë‹¤ í° ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. ì–¼ë§ˆë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?', 'transfer-chat-messages', 'chat-bubble-bot');
                         document.getElementById('transfer-chat-input').type = 'number';
                    }
                    break;
                case 'account':
                    transferData.account = userData; 
                    currentTransferStep = 'confirm';
                    const confirmMsg = `ì•Œê² ìŠµë‹ˆë‹¤! ${escapeHTML(transferData.recipient)}ë‹˜ì—ê²Œ ${escapeHTML(transferData.amount.toLocaleString())}ì›ì„ ${escapeHTML(transferData.account)} ê³„ì¢Œì—ì„œ ì†¡ê¸ˆí• ê¹Œìš”?`;
                    addMessageToChat('bot', confirmMsg, 'transfer-chat-messages', 'chat-bubble-bot');
                    showConfirmationQuickReplies();
                    document.getElementById('transfer-chat-input').disabled = true; 
                    break;
                case 'confirm': 
                    if (userData.toLowerCase() === 'ì†¡ê¸ˆ ì‹¤í–‰') {
                        executeTransferViaChat();
                    } else {
                        addMessageToChat('bot', 'ì†¡ê¸ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œë ¤ë©´ ë’¤ë¡œê°€ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'transfer-chat-messages', 'chat-bubble-bot');
                        clearQuickReplies(); 
                    }
                    break;
            }
        }

        function showAccountQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            area.innerHTML = ''; 
            availableAccounts.forEach(acc => {
                const button = document.createElement('button');
                button.className = 'quick-reply-button';
                button.textContent = acc.name;
                button.onclick = () => handleTransferChatInput(false, acc.name); 
                area.appendChild(button);
            });
        }
        
        function showConfirmationQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            area.innerHTML = '';
            const confirmButton = document.createElement('button');
            confirmButton.className = 'quick-reply-button bg-shinhan-blue text-white';
            confirmButton.textContent = 'âœ… ì†¡ê¸ˆ ì‹¤í–‰';
            confirmButton.onclick = () => { 
                clearQuickReplies(); 
                processTransferStep('ì†¡ê¸ˆ ì‹¤í–‰'); 
            };
            area.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button bg-gray-400 text-white';
            cancelButton.textContent = 'âŒ ì·¨ì†Œ';
            cancelButton.onclick = () => { 
                clearQuickReplies(); 
                processTransferStep('ì·¨ì†Œ'); 
            };
            area.appendChild(cancelButton);
        }

        function clearQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            if(area) area.innerHTML = '';
        }
        
        async function executeTransferViaChat() {
            addMessageToChat('bot', `${escapeHTML(transferData.recipient)}ë‹˜ì—ê²Œ ${escapeHTML(transferData.amount.toLocaleString())}ì› ì†¡ê¸ˆì„ ìš”ì²­í•©ë‹ˆë‹¤... (ì„±ê³µ!)`, 'transfer-chat-messages', 'chat-bubble-bot');
            
            document.getElementById('transfer-input-area').style.display = 'none'; 
            document.getElementById('transfer-summary-display').style.display = 'block'; 
            const summaryDiv = document.getElementById('ai-transfer-summary-text');
            
            let structuredSummaryHtml = `
                <p><strong>ë°›ëŠ”ì‚¬ëŒ :</strong> ${escapeHTML(transferData.recipient)}</p>
                <p><strong>ê¸ˆì•¡ :</strong> ${escapeHTML(transferData.amount.toLocaleString())} ì›</p>
                <p><strong>ì¶œê¸ˆí†µì¥ :</strong> ${escapeHTML(transferData.account)}</p>
                <br>
                <p>ì´ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <hr class="my-2 border-gray-300">
                <div id="gemini-friendly-summary-placeholder" class="mt-1">
                    <div class="loader_small inline-block border-2 border-gray-200 border-top-2 border-shinhan-blue rounded-full w-4 h-4 animate-spin mr-1"></div> AI ì¹œì ˆ ìš”ì•½ ìƒì„± ì¤‘...
                </div>
            `;
            summaryDiv.innerHTML = structuredSummaryHtml;

            const prompt = `"${transferData.recipient}"ì—ê²Œ ${transferData.amount}ì› (${transferData.account} ê³„ì¢Œì—ì„œ) ì´ì²´ê°€ ë°©ê¸ˆ ì™„ë£Œëœ ìƒí™©ì— ëŒ€í•´, ë°›ëŠ” ì‚¬ëŒì—ê²Œ ì „ë‹¬í•  ì§§ê³  ì¹œê·¼í•œ í•œ ë¬¸ì¥ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì¤˜ (ì´ëª¨ì§€ 1ê°œ ì‚¬ìš© ê°€ëŠ¥). ì˜ˆë¥¼ ë“¤ì–´ "OOë‹˜ê»˜ X,XXXì› ì†¡ê¸ˆ ì™„ë£Œ! ì¦ê±°ìš´ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ğŸ˜Š" ì™€ ê°™ì´ ì‘ì„±í•´ì¤˜.`;
            const friendlySummaryText = await callGeminiAPI(prompt, false); 
            
            const geminiPlaceholder = document.getElementById('gemini-friendly-summary-placeholder');
            if (geminiPlaceholder) {
                if (friendlySummaryText && typeof marked !== 'undefined') {
                    geminiPlaceholder.innerHTML = `<strong>AI ì½”ë©˜íŠ¸:</strong> ${marked.parse(friendlySummaryText)}`;
                } else if (friendlySummaryText) { 
                     geminiPlaceholder.innerHTML = `<strong>AI ì½”ë©˜íŠ¸:</strong> ${escapeHTML(friendlySummaryText)}`;
                }
                else {
                    geminiPlaceholder.innerHTML = `<strong>AI ì½”ë©˜íŠ¸:</strong> ì´ì²´ë‚´ì—­ ìš”ì•½ ì½”ë©˜íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥`;
                }
            }
        }

        function resetAndGoBackFromTransfer() { 
            document.getElementById('transfer-summary-display').style.display = 'none';
            showPage(previousPageForTransfer || 'page-main'); 
        }
         function cancelTransferAndGoBack() { 
            showToast("ì†¡ê¸ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            transferData = { recipient: '', amount: '', account: '' };
            currentTransferStep = '';
            document.getElementById('transfer-chat-messages').innerHTML = '';
            clearQuickReplies();
            showPage(previousPageForTransfer || 'page-main'); 
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }

        let toastTimeout;
        function showToast(message, duration = 2500) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;
            if (typeof message === 'string' && (message.includes('<') || message.includes('&'))) { 
                 toast.innerHTML = message; 
            } else {
                 toast.textContent = message;
            }
            toast.style.opacity = '1';
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.opacity = '0'; }, duration);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const initialResultsContent = document.getElementById('search-results-content');
             if (initialResultsContent && initialResultsContent.innerHTML.trim() === "") {
                 initialResultsContent.innerHTML = `
                    <div onclick="showServiceDetail('ì¶”ì²œ ê²€ìƒ‰ ê²°ê³¼ ì˜ˆì‹œ 1')" class="bg-shinhan-gray p-4 rounded-lg shadow flex justify-between items-center cursor-pointer hover:bg-gray-200 transition-all">
                        <span class="text-shinhan-dark-gray">ì¶”ì²œ ê²€ìƒ‰ ê²°ê³¼ ì˜ˆì‹œ 1</span><i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                     <div onclick="goToTransferFromSearchResults('ì¶”ì²œ ê²€ìƒ‰')" class="bg-shinhan-gray p-4 rounded-lg shadow flex justify-between items-center cursor-pointer hover:bg-gray-200 transition-all">
                        <span class="text-shinhan-dark-gray">ì¶”ì²œ ê²€ìƒ‰ í›„ ì†¡ê¸ˆí•˜ê¸°</span><i class="fas fa-chevron-right text-gray-400"></i>
                    </div>`;
            }
            showPage('page-cover'); 
            
            const transferChatInput = document.getElementById('transfer-chat-input');
            if (transferChatInput) {
                transferChatInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleTransferChatInput(true);
                    }
                });
            }
            updateActiveNavButton(); // Update nav based on initial page (cover will hide it)
        });
    </script>
</body>
</html>
