<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER SOL - 프로토타입</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN (corrected integrity attribute) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior-y: contain; 
        }
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shinhan-dark-blue': '#004098',
                        'shinhan-blue': '#0072CE',
                        'shinhan-light-blue': '#E6F2FF',
                        'shinhan-gray': '#F5F7FA',
                        'shinhan-dark-gray': '#2E3A59',
                    }
                }
            }
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            width: 100%;
            background-color: white; 
            height: 100vh; /* Ensure pages take full viewport height */
            flex-direction: column; /* Default to column for page content */
        }
        .page.active {
            display: flex; 
        }
        /* page-main and page-chat need space for bottom nav */
        #page-main.active, #page-chat.active {
            height: calc(100vh - 4rem); /* Adjust height considering bottom nav */
            overflow-y: auto;
        }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cover-gradient {
            background: linear-gradient(to bottom right, #004098, #005cb9);
            /* min-height: 100vh; */
            position: absolute; top:0; left:0; 
        }
        .search-bar-shadow {
            box-shadow: 0 4px 12px rgba(0, 114, 206, 0.2);
        }
        .chat-bubble {
            animation: slideUp 0.3s ease-out;
            max-width: 80%; 
        }
        .chat-bubble-user {
            background-color: #0072CE; 
            color: white;
        }
        .chat-bubble-bot {
            background-color: #E6F2FF; 
            color: #2E3A59; 
        }
        .chat-bubble-bot table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .chat-bubble-bot th, .chat-bubble-bot td {
            border: 1px solid #cccccc;
            padding: 6px 10px;
            text-align: left;
        }
        .chat-bubble-bot th {
            background-color: #f0f0f0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0072CE;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .quick-reply-button {
            background-color: #0072CE;
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            margin: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quick-reply-button:hover {
            background-color: #005cb9;
        }
        #page-main {
            padding-bottom: 1rem; 
        }
        #transfer-chat-messages {
            min-height: 450px; 
        }
        #chat-messages-container { /* For SOLbot chat */
             flex-grow: 1;
             overflow-y: auto;
             padding: 1rem;
        }
        #solbot-input-container { /* For SOLbot chat */
            background-color: white;
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb; /* Tailwind gray-200 */
        }

    </style>
</head>
<body class="bg-white overflow-hidden"> 

    <div id="loading-indicator" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <!-- 페이지 컨테이너 -->
    <div id="app-container" class="relative w-full max-w-md mx-auto h-screen overflow-hidden border border-gray-300 rounded-lg shadow-xl">

        <!-- Page 1: Cover -->
        <div id="page-cover" class="page active cover-gradient items-center justify-center p-8 text-white text-center">
            <div class="text-5xl font-bold mb-4">
                <i class="fas fa-bolt-lightning"></i> SOL
            </div>
            <h1 class="text-3xl font-bold mb-2">SUPER SOL</h1>
            <p class="text-lg mb-8">"말하면 다 되는 똑똑한 금융 생활"</p>
            <div class="w-full max-w-sm mt-8">
                <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="cover-search-input" placeholder="무엇을 도와드릴까요?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleCoverSearch(event)">
                    <button onclick="handleCoverSearch(null, false, true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="handleCoverSearch(null, true, false)" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">말하기</span>
                    </button>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-200">예: "송금", "계좌 조회"</p>
             <button onclick="showPage('page-main')" class="mt-8 text-gray-300 hover:text-white underline">
                또는, 둘러보기
            </button>
        </div>

        <!-- Page 2: Main UI -->
        <div id="page-main" class="page bg-white no-scrollbar"> 
            <!-- 검색바 (Main) -->
            <div class="p-4 sticky top-0 bg-white z-10">
                 <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="main-search-input" placeholder="무엇을 도와드릴까요?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleMainSearch(event)">
                     <button onclick="handleMainSearch(null, false, true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="handleMainSearch(null, true, false)" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">말하기</span>
                    </button>
                </div>
            </div>
            <!-- 추천 서비스 (Main) -->
            <div class="p-4 space-y-3">
                <h2 class="text-lg font-semibold text-shinhan-dark-gray mb-3 px-2">추천 서비스</h2>
                <div onclick="showService('잔액조회')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">💰 잔액조회</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="goToTransferFromMainUI()" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">💸 송금</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="showService('투자 추천')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">📈 투자 추천</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="showService('환율 정보')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">🌍 환율 정보</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="getFinancialTip()" class="bg-shinhan-light-blue hover:bg-blue-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all mt-4">
                    <span class="text-shinhan-blue font-semibold text-md">✨ 오늘의 AI 금융 팁</span>
                    <i class="fas fa-lightbulb text-shinhan-blue"></i>
                </div>
            </div>
            <!-- SOLbot section removed from here -->
             <div class="h-16"></div> 
        </div>


        <!-- Page 3: Search Results -->
        <div id="page-search-results" class="page bg-white"> 
             <div class="w-full h-full bg-white z-20 flex flex-col"> 
                <div class="p-4 sticky top-0 bg-white z-10 border-b">
                    <button onclick="showPage('page-main');" class="text-shinhan-blue absolute top-1/2 left-4 transform -translate-y-1/2">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-shinhan-dark-gray text-center py-3">검색 결과</h2>
                </div>
                <div class="p-4 flex-grow overflow-y-auto no-scrollbar">
                    <p class="text-sm text-center text-shinhan-blue mb-4">✨ AI가 추천하는 결과입니다 ✨</p>
                    <div class="space-y-3" id="search-results-content">
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: SOLbot Chat (Restored as a separate page) -->
        <div id="page-chat" class="page bg-gray-100">
            <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                <button onclick="showPage('page-main')" class="text-shinhan-blue mr-3">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                    <i class="fas fa-robot"></i>
                </div>
                <h2 class="text-xl font-semibold text-shinhan-dark-gray">SOL봇</h2>
            </div>
            <div id="chat-messages-container" class="no-scrollbar">
                <div id="chat-messages" class="p-4 space-y-4"> 
                    <!-- Initial SOLbot welcome message will be added by JS -->
                </div>
            </div>
            <div id="solbot-input-container" class="flex-shrink-0"> 
                <div class="flex items-center bg-gray-100 rounded-full p-1">
                    <input type="text" id="chat-input" placeholder="메시지를 입력하거나 말해주세요" class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500" onkeypress="handleChatInput(event)">
                    <button onclick="sendChatMessage(null, true)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                     <button onclick="sendChatMessage(document.getElementById('chat-input').value, false)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </div>
        </div>


        <!-- Page 5: Transfer (채팅형 송금) -->
        <div id="page-transfer" class="page bg-gray-100"> 
            <div class="w-full h-full bg-gray-100 z-20 flex flex-col"> 
                <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                    <button onclick="cancelTransferAndGoBack()" class="text-shinhan-blue mr-3">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                        <i class="fas fa-comments-dollar"></i> 
                    </div>
                    <h2 class="text-xl font-semibold text-shinhan-dark-gray">송금하기</h2>
                </div>
                <div id="transfer-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto no-scrollbar">
                    {/* 송금 챗봇 메시지 */}
                </div>
                 <div id="transfer-summary-display" class="p-4 bg-white border-t flex-shrink-0" style="display:none;">
                    <h3 class="text-md font-semibold text-shinhan-dark-gray mb-2 text-center">✨ AI 이체내역 요약 ✨</h3>
                    <div id="ai-transfer-summary-text" class="bg-shinhan-light-blue text-shinhan-dark-gray p-3 rounded-lg shadow text-sm mb-3 text-left">
                        {/* AI 요약 내용이 여기에 표시됨 */}
                    </div>
                    <button onclick="resetAndGoBackFromTransfer()" class="w-full bg-shinhan-blue hover:bg-shinhan-dark-blue text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">
                        확인
                    </button>
                </div>
                <div id="transfer-input-area" class="bg-white p-3 border-t flex-shrink-0"> 
                    <div class="flex items-center bg-gray-100 rounded-full p-1">
                        <input type="text" id="transfer-chat-input" placeholder="답변을 입력해주세요..." class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500">
                        <button onclick="handleTransferChatInput(true)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                     <div id="transfer-quick-reply-area" class="flex flex-wrap justify-center mt-2">
                        {/* 빠른 응답 버튼 */}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 하단 고정 네비게이션 -->
        <div id="bottom-navigation" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 p-2 flex justify-around items-center h-16 z-30">
             <button onclick="showPage('page-cover')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center">
                <i class="fas fa-sign-out-alt text-xl"></i> <span class="text-xs">첫화면</span>
            </button>
            <button onclick="showPage('page-main')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center" id="nav-home-button">
                <i class="fas fa-home text-xl"></i> <span class="text-xs">홈</span>
            </button>
            <button onclick="showPage('page-chat')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center" id="nav-solbot-button">
                <i class="fas fa-robot text-xl"></i> <span class="text-xs">SOL봇</span>
            </button>
            <button onclick="showToast('전체메뉴는 준비 중입니다.')" class="text-gray-500 hover:text-shinhan-blue flex flex-col items-center">
                <i class="fas fa-bars text-xl"></i> <span class="text-xs">전체메뉴</span>
            </button>
        </div>

    </div>

    <div id="toast-message" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        메시지 내용
    </div>

    <script>
        let currentPage = 'page-cover';
        let previousPageForTransfer = 'page-main'; // Default to main if transfer initiated weirdly
        let initialSolbotQuery = null; // To pass initial query from main search to SOLbot
        
        const GEMINI_API_KEY = "AIzaSyDfghlU_a0nTRFDOdDYampJl8XQdXh4_zQ"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        let currentTransferStep = ''; 
        let transferData = { recipient: '', amount: '', account: '' };
        const availableAccounts = [ 
            { name: "신한 주거래 우대통장", number: "110-***-123456" },
            { name: "쏠편한 입출금통장", number: "123-***-789012" },
            { name: "MY 급여통장", number: "456-***-789000" }
        ];

        async function callGeminiAPI(prompt, forChat = false) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    if (forChat) { 
                         throw new Error(`API 요청 실패: ${response.status}`);
                    }
                    return null; 
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API 응답 형식 오류:", result);
                    if (forChat) return "죄송해요, 지금은 답변을 드리기 어렵네요.";
                    return null; 
                }
            } catch (error) {
                console.error('Gemini API 호출 중 오류 발생:', error);
                 if (forChat) showToast(`오류: ${error.message.substring(0,100)}`); 
                return forChat ? "죄송해요, 네트워크 오류가 발생했어요." : null; 
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        function updateActiveNavButton() {
            const homeButton = document.getElementById('nav-home-button');
            const solbotButton = document.getElementById('nav-solbot-button');
            
            [homeButton, solbotButton].forEach(btn => {
                if(btn) {
                    btn.classList.remove('text-shinhan-blue', 'font-semibold');
                    btn.classList.add('text-gray-500');
                }
            });

            if (currentPage === 'page-main' ) {
                 if(homeButton) {
                    homeButton.classList.add('text-shinhan-blue', 'font-semibold');
                    homeButton.classList.remove('text-gray-500');
                 }
            } else if (currentPage === 'page-chat') {
                if(solbotButton) {
                    solbotButton.classList.add('text-shinhan-blue', 'font-semibold');
                    solbotButton.classList.remove('text-gray-500');
                }
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            const bottomNav = document.getElementById('bottom-navigation');

            if (target) {
                target.classList.add('active');
                currentPage = pageId; // Update currentPage immediately

                if (pageId === 'page-main' || pageId === 'page-chat') {
                    if(bottomNav) bottomNav.style.display = 'flex';
                    target.style.position = 'relative'; // Ensure it's part of the flow
                    target.style.height = 'calc(100vh - 4rem)'; // Space for bottom nav
                    target.scrollTop = 0; // Scroll to top for these pages
                } else { // Overlay pages like cover, search-results, transfer
                    if(bottomNav) bottomNav.style.display = 'none';
                    target.style.position = 'absolute';
                    target.style.top = '0';
                    target.style.left = '0';
                    target.style.height = '100vh'; // Full height for overlays
                    target.style.zIndex = '20'; 
                }
                updateActiveNavButton(); // Update nav button based on the new currentPage


                if (pageId === 'page-transfer') {
                    startTransferChat(); 
                } else if (pageId === 'page-chat') {
                    initializeSolbotChat();
                } else if (['page-search-results'].includes(pageId)) {
                     target.querySelector('.overflow-y-auto')?.scrollTo(0,0);
                }
            }
        }
        
        function initializeSolbotChat() {
            const chatMessagesArea = document.getElementById('chat-messages');
            // Clear previous messages except for a new welcome message if it's a fresh load
            if (chatMessagesArea) {
                 chatMessagesArea.innerHTML = ''; // Clear old messages
                 addMessageToChat("AI", "안녕하세요! 저는 SUPER SOL의 AI 비서 SOL봇입니다. 무엇을 도와드릴까요?", 'chat-messages', 'chat-bubble-bot');
            }

            if (initialSolbotQuery) {
                sendChatMessage(initialSolbotQuery, false, true); // Send initial query if present
                initialSolbotQuery = null; // Clear after use
            }
        }


        function handleCoverSearch(event, isVoice = false, isSearchIcon = false) {
            const input = document.getElementById('cover-search-input');
            const query = input ? input.value.trim().toLowerCase() : "";
            let executeAction = false;

            if (event && event.key === 'Enter' && query) executeAction = true;
            else if (isSearchIcon && query) executeAction = true;
            else if (isVoice && query) executeAction = true; 
            else if (isVoice && !query) { 
                 showToast("음성으로 말씀해주세요. 예: 'OOO에게 송금'");
                 return;
            } else if ((event && event.key === 'Enter' && !query) || (isSearchIcon && !query)) {
                 showToast("검색어를 입력해주세요.");
                 return;
            }
            
            if (executeAction) {
                previousPageForTransfer = 'page-cover'; 
                if (query.includes("송금") || query.includes("보내줘") || query.includes("이체")) {
                    showToast(`'${escapeHTML(query)}' 요청 확인. 송금 서비스로 연결합니다.`);
                    setTimeout(() => { showPage('page-transfer'); if(input) input.value = ""; }, 500);
                } else {
                    showToast(`'${escapeHTML(query)}'에 대해 SOL봇에게 물어볼게요.`);
                    initialSolbotQuery = query;
                    setTimeout(() => { showPage('page-chat'); if(input) input.value = ""; }, 500);
                }
            }
        }

        function handleMainSearch(event, isVoice = false, isSearchIcon = false) {
            const input = document.getElementById('main-search-input');
            const query = input ? input.value.trim().toLowerCase() : "";
            let performAction = false;

            if (isVoice && query) performAction = true;
            else if (isVoice && !query) {
                showToast("음성으로 '송금' 또는 검색어를 말씀해주세요. SOL봇에게 직접 물어보세요!");
                // For voice without query, directly go to SOLbot page maybe? Or keep current page.
                // For now, just a toast. Could also call showPage('page-chat');
                return;
            }
            else if (event && event.key === 'Enter' && query) performAction = true;
            else if (isSearchIcon && query) performAction = true;
            else if (((event && event.key === 'Enter') || isSearchIcon) && !query) {
                 showToast("검색어를 입력해주세요.");
                 return;
            }

            if (performAction) {
                previousPageForTransfer = 'page-main'; // Set context for transfer page
                if (query.includes("송금") || query.includes("보내줘") || query.includes("이체")) {
                    showToast(`'${escapeHTML(query)}' 요청 확인. 송금 화면으로 이동합니다.`);
                    setTimeout(() => {
                        showPage('page-transfer');
                        if(input) input.value = "";
                    }, 500);
                } else if (query) { 
                    showToast(`'${escapeHTML(query)}'에 대해 SOL봇에게 물어볼게요.`);
                    initialSolbotQuery = query; // Pass query to SOLbot page
                    setTimeout(() => { 
                        showPage('page-chat');
                        if(input) input.value = "";
                    }, 500); 
                }
            }
        }
        
        async function getFinancialTip() {
            showToast("✨ AI가 오늘의 금융 팁을 생성 중입니다...");
            const prompt = "일반적인 사용자를 위한 짧고 실용적인 금융 팁 하나만 한국어로 알려줘. 이모지를 사용해서 친근하게 표현해줘.";
            const tip = await callGeminiAPI(prompt);
            if (tip) { 
                showToast(marked.parse(tip), 5000); 
            } else { 
                showToast("금융 팁을 가져오는데 알 수 없는 문제가 발생했어요. 😥");
            }
        }

        function goToTransferFromMainUI() {
            previousPageForTransfer = 'page-main';
            showPage('page-transfer');
        }
        
        function handleChatInput(event) { 
            if (event.key === 'Enter') {
                sendChatMessage(document.getElementById('chat-input').value, false);
            }
        }
        
        async function sendChatMessage(message, isVoice = false, isInitialQuery = false) { 
            const chatInput = document.getElementById('chat-input'); // Assuming this is for SOLbot chat page
            const messageText = (typeof message === 'string' ? message.trim() : (chatInput ? chatInput.value.trim() : ""));
            let userPrompt = messageText;

            if (isVoice && !messageText && !isInitialQuery) {
                userPrompt = "음성으로 질문합니다: (사용자가 말하는 중...)"; 
                showToast("음성 인식을 시작합니다..."); 
            }
            if (!userPrompt && !isInitialQuery) { // Allow empty initial query if page loaded with it
                 showToast("메시지를 입력해주세요.");
                return;
            }
            
            if (userPrompt) { // Only add user message if there is a prompt
                addMessageToChat("user", userPrompt, 'chat-messages', 'chat-bubble-user');
            }
            if(chatInput && !isInitialQuery) chatInput.value = ''; // Don't clear if it's an initial query that auto-sent

            // Use the original userPrompt (which might be from initialSolbotQuery)
            const aiResponseText = await callGeminiAPI(userPrompt || "안녕하세요.", true); // Send "안녕하세요" if prompt is empty after all
            addMessageToChat("AI", aiResponseText, 'chat-messages', 'chat-bubble-bot');
        }

        function addMessageToChat(sender, text, messageAreaId, bubbleClass) {
            const messagesArea = document.getElementById(messageAreaId);
            if(!messagesArea) return; 
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full`; 
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-lg shadow chat-bubble ${bubbleClass}`;
            
            if (sender === 'AI' && typeof marked !== 'undefined' && text) {
                bubbleDiv.innerHTML = marked.parse(text); 
            } else if (text) {
                bubbleDiv.textContent = text; 
            } else {
                bubbleDiv.textContent = ""; 
            }
            
            messageDiv.appendChild(bubbleDiv);
            messagesArea.appendChild(messageDiv);
            // Ensure the parent container (#chat-messages-container) is scrolled, not just the inner div
            const container = document.getElementById('chat-messages-container');
            if(container) container.scrollTop = container.scrollHeight;
            else messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function startTransferChat() {
            document.getElementById('transfer-chat-messages').innerHTML = ''; 
            document.getElementById('transfer-summary-display').style.display = 'none'; 
            document.getElementById('transfer-input-area').style.display = 'block'; 
            document.getElementById('transfer-chat-input').disabled = false;

            transferData = { recipient: '', amount: '', account: '' }; 
            currentTransferStep = 'recipient';
            addMessageToChat('bot', '누구에게 보내시겠습니까? 계좌번호나 이름을 입력해주세요.', 'transfer-chat-messages', 'chat-bubble-bot');
            clearQuickReplies();
            document.getElementById('transfer-chat-input').placeholder = '받는 분 입력...';
            document.getElementById('transfer-chat-input').type = 'text';
        }

        function handleTransferChatInput(isSendButton = false, quickReplyValue = null) {
            const input = document.getElementById('transfer-chat-input');
            const userText = quickReplyValue !== null ? quickReplyValue : (input ? input.value.trim() : "");

            if (!userText) {
                showToast("답변을 입력해주세요.");
                return;
            }
            
            addMessageToChat('user', userText, 'transfer-chat-messages', 'chat-bubble-user');
            if(input) input.value = ''; 
            clearQuickReplies(); 

            setTimeout(() => { 
                processTransferStep(userText);
            }, 300);
        }

        function processTransferStep(userData) {
            switch(currentTransferStep) {
                case 'recipient':
                    transferData.recipient = userData;
                    currentTransferStep = 'amount';
                    addMessageToChat('bot', `네, ${escapeHTML(transferData.recipient)}님에게 보내시는군요. 얼마를 보내시겠습니까? (숫자만 입력)`, 'transfer-chat-messages', 'chat-bubble-bot');
                    document.getElementById('transfer-chat-input').type = 'number'; 
                    document.getElementById('transfer-chat-input').placeholder = '금액(숫자) 입력...';
                    break;
                case 'amount':
                    if (!isNaN(parseFloat(userData)) && isFinite(userData) && parseFloat(userData) > 0) {
                        transferData.amount = parseFloat(userData);
                        currentTransferStep = 'account';
                        addMessageToChat('bot', `${escapeHTML(transferData.amount.toLocaleString())}원을 보내시는군요. 어떤 계좌에서 출금할까요? 아래에서 선택하거나 직접 입력해주세요.`, 'transfer-chat-messages', 'chat-bubble-bot');
                        document.getElementById('transfer-chat-input').type = 'text';
                        document.getElementById('transfer-chat-input').placeholder = '계좌 별칭 또는 선택...';
                        showAccountQuickReplies();
                    } else {
                         addMessageToChat('bot', '금액은 0보다 큰 숫자로 정확히 입력해주세요. 얼마를 보내시겠습니까?', 'transfer-chat-messages', 'chat-bubble-bot');
                         document.getElementById('transfer-chat-input').type = 'number';
                    }
                    break;
                case 'account':
                    transferData.account = userData; 
                    currentTransferStep = 'confirm';
                    const confirmMsg = `알겠습니다! ${escapeHTML(transferData.recipient)}님에게 ${escapeHTML(transferData.amount.toLocaleString())}원을 ${escapeHTML(transferData.account)} 계좌에서 송금할까요?`;
                    addMessageToChat('bot', confirmMsg, 'transfer-chat-messages', 'chat-bubble-bot');
                    showConfirmationQuickReplies();
                    document.getElementById('transfer-chat-input').disabled = true; 
                    break;
                case 'confirm': 
                    if (userData.toLowerCase() === '송금 실행') {
                        executeTransferViaChat();
                    } else {
                        addMessageToChat('bot', '송금이 취소되었습니다. 처음부터 다시 시작하시려면 뒤로가기를 눌러주세요.', 'transfer-chat-messages', 'chat-bubble-bot');
                        clearQuickReplies(); 
                    }
                    break;
            }
        }

        function showAccountQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            area.innerHTML = ''; 
            availableAccounts.forEach(acc => {
                const button = document.createElement('button');
                button.className = 'quick-reply-button';
                button.textContent = acc.name;
                button.onclick = () => handleTransferChatInput(false, acc.name); 
                area.appendChild(button);
            });
        }
        
        function showConfirmationQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            area.innerHTML = '';
            const confirmButton = document.createElement('button');
            confirmButton.className = 'quick-reply-button bg-shinhan-blue text-white';
            confirmButton.textContent = '✅ 송금 실행';
            confirmButton.onclick = () => { 
                clearQuickReplies(); 
                processTransferStep('송금 실행'); 
            };
            area.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button bg-gray-400 text-white';
            cancelButton.textContent = '❌ 취소';
            cancelButton.onclick = () => { 
                clearQuickReplies(); 
                processTransferStep('취소'); 
            };
            area.appendChild(cancelButton);
        }

        function clearQuickReplies() {
            const area = document.getElementById('transfer-quick-reply-area');
            if(area) area.innerHTML = '';
        }
        
        async function executeTransferViaChat() {
            addMessageToChat('bot', `${escapeHTML(transferData.recipient)}님에게 ${escapeHTML(transferData.amount.toLocaleString())}원 송금을 요청합니다... (성공!)`, 'transfer-chat-messages', 'chat-bubble-bot');
            
            document.getElementById('transfer-input-area').style.display = 'none'; 
            document.getElementById('transfer-summary-display').style.display = 'block'; 
            const summaryDiv = document.getElementById('ai-transfer-summary-text');
            
            let structuredSummaryHtml = `
                <p><strong>받는사람 :</strong> ${escapeHTML(transferData.recipient)}</p>
                <p><strong>금액 :</strong> ${escapeHTML(transferData.amount.toLocaleString())} 원</p>
                <p><strong>출금통장 :</strong> ${escapeHTML(transferData.account)}</p>
                <br>
                <p>이체되었습니다.</p>
                <hr class="my-2 border-gray-300">
                <div id="gemini-friendly-summary-placeholder" class="mt-1">
                    <div class="loader_small inline-block border-2 border-gray-200 border-top-2 border-shinhan-blue rounded-full w-4 h-4 animate-spin mr-1"></div> AI 친절 요약 생성 중...
                </div>
            `;
            summaryDiv.innerHTML = structuredSummaryHtml;

            const prompt = `"${transferData.recipient}"에게 ${transferData.amount}원 (${transferData.account} 계좌에서) 이체가 방금 완료된 상황에 대해, 받는 사람에게 전달할 짧고 친근한 한 문장 메시지를 한국어로 작성해줘 (이모지 1개 사용 가능). 예를 들어 "OO님께 X,XXX원 송금 완료! 즐거운 하루 보내세요! 😊" 와 같이 작성해줘.`;
            const friendlySummaryText = await callGeminiAPI(prompt, false); 
            
            const geminiPlaceholder = document.getElementById('gemini-friendly-summary-placeholder');
            if (geminiPlaceholder) {
                if (friendlySummaryText && typeof marked !== 'undefined') {
                    geminiPlaceholder.innerHTML = `<strong>AI 코멘트:</strong> ${marked.parse(friendlySummaryText)}`;
                } else if (friendlySummaryText) { 
                     geminiPlaceholder.innerHTML = `<strong>AI 코멘트:</strong> ${escapeHTML(friendlySummaryText)}`;
                }
                else {
                    geminiPlaceholder.innerHTML = `<strong>AI 코멘트:</strong> 이체내역 요약 코멘트를 가져올 수 없습니다. 😥`;
                }
            }
        }

        function resetAndGoBackFromTransfer() { 
            document.getElementById('transfer-summary-display').style.display = 'none';
            showPage(previousPageForTransfer || 'page-main'); 
        }
         function cancelTransferAndGoBack() { 
            showToast("송금이 취소되었습니다.");
            transferData = { recipient: '', amount: '', account: '' };
            currentTransferStep = '';
            document.getElementById('transfer-chat-messages').innerHTML = '';
            clearQuickReplies();
            showPage(previousPageForTransfer || 'page-main'); 
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }

        let toastTimeout;
        function showToast(message, duration = 2500) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;
            if (typeof message === 'string' && (message.includes('<') || message.includes('&'))) { 
                 toast.innerHTML = message; 
            } else {
                 toast.textContent = message;
            }
            toast.style.opacity = '1';
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.opacity = '0'; }, duration);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const initialResultsContent = document.getElementById('search-results-content');
             if (initialResultsContent && initialResultsContent.innerHTML.trim() === "") {
                 initialResultsContent.innerHTML = `
                    <div onclick="showServiceDetail('추천 검색 결과 예시 1')" class="bg-shinhan-gray p-4 rounded-lg shadow flex justify-between items-center cursor-pointer hover:bg-gray-200 transition-all">
                        <span class="text-shinhan-dark-gray">추천 검색 결과 예시 1</span><i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                     <div onclick="goToTransferFromSearchResults('추천 검색')" class="bg-shinhan-gray p-4 rounded-lg shadow flex justify-between items-center cursor-pointer hover:bg-gray-200 transition-all">
                        <span class="text-shinhan-dark-gray">추천 검색 후 송금하기</span><i class="fas fa-chevron-right text-gray-400"></i>
                    </div>`;
            }
            showPage('page-cover'); 
            
            const transferChatInput = document.getElementById('transfer-chat-input');
            if (transferChatInput) {
                transferChatInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleTransferChatInput(true);
                    }
                });
            }
            updateActiveNavButton(); // Update nav based on initial page (cover will hide it)
        });
    </script>
</body>
</html>
