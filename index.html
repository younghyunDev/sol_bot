<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache-Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>SUPER SOL - í”„ë¡œí† íƒ€ì…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind CSS Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shinhan-dark-blue': '#004098',
                        'shinhan-blue': '#0072CE',
                        'shinhan-light-blue': '#E6F2FF',
                        'shinhan-gray': '#F5F7FA',
                        'shinhan-dark-gray': '#2E3A59',
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior-y: contain; 
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            width: 100%;
            background-color: white; 
            height: 100vh; 
            flex-direction: column; 
        }
        .page.active {
            display: flex; 
        }
        /* All pages now have full height and manage their own scroll */
        #page-main, #page-chat, #page-transfer, #page-balance {
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .cover-gradient {
            background: linear-gradient(to bottom right, #004098, #005cb9);
            position: absolute; top:0; left:0; 
        }
        .search-bar-shadow {
            box-shadow: 0 4px 12px rgba(0, 114, 206, 0.2);
        }
        .chat-bubble {
            animation: slideUp 0.3s ease-out;
            max-width: 85%; 
        }
        .chat-bubble-user {
            background-color: #0072CE; 
            color: white;
        }
        .chat-bubble-bot {
            background-color: #E6F2FF; 
            color: #2E3A59; 
        }
        .chat-bubble-bot table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: white;
        }
        .chat-bubble-bot th, .chat-bubble-bot td {
            border: 1px solid #cccccc;
            padding: 6px 10px;
            text-align: left;
        }
        .chat-bubble-bot th {
            background-color: #f0f0f0;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0072CE;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .quick-reply-button {
            background-color: #0072CE;
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            margin: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quick-reply-button:hover {
            background-color: #005cb9;
        }
        #transfer-quick-reply-area select {
            width: 100%;
            max-width: 280px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 8px;
            color: black;
            font-size: 0.875rem;
        }
        #chat-messages-container { 
             flex-grow: 1;
             overflow-y: auto;
             padding: 1rem;
        }
        #solbot-input-container { 
            background-color: white;
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-white overflow-hidden"> 

    <div id="loading-indicator" class="loading-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <!-- í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container" class="relative w-full max-w-md mx-auto h-screen overflow-hidden border border-gray-300 rounded-lg shadow-xl">

        <!-- Page 1: Cover -->
        <div id="page-cover" class="page active items-center justify-center p-8 text-white text-center cover-gradient">
            <div class="text-5xl font-bold mb-4">
                <i class="fas fa-bolt-lightning"></i> SOL
            </div>
            <h1 class="text-3xl font-bold mb-2">SUPER SOL</h1>
            <p class="text-lg mb-8">"ë§í•˜ë©´ ë‹¤ ë˜ëŠ” ë˜‘ë˜‘í•œ ê¸ˆìœµ ìƒí™œ"</p>
            <div class="w-full max-w-sm mt-8">
                <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="cover-search-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleSearch(event, 'cover-search-input')">
                    <button onclick="handleSearch(null, 'cover-search-input', true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2 z-10">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="startSpeechRecognition('cover-search-input')" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors z-10">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">ë§í•˜ê¸°</span>
                    </button>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-200">ì˜ˆ: "ê¹€ì‹ í•œì—ê²Œ 5ë§Œì› ë³´ë‚´ì¤˜", "ì˜¤ëŠ˜ì˜ í™˜ìœ¨ ì•Œë ¤ì¤˜"</p>
             <button onclick="showPage('page-main')" class="mt-8 text-gray-300 hover:text-white underline">
                í™ˆìœ¼ë¡œ ë°”ë¡œê°€ê¸°
            </button>
        </div>

        <!-- Page 2: Main UI -->
        <div id="page-main" class="page bg-white no-scrollbar"> 
            <div class="p-4 sticky top-0 bg-white z-10 border-b">
                 <div class="relative flex items-center bg-white border-2 border-shinhan-blue rounded-full h-16 search-bar-shadow">
                    <input type="text" id="main-search-input" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?" class="w-full h-full pl-6 pr-28 rounded-full text-lg placeholder-gray-400 focus:outline-none text-black" onkeypress="handleSearch(event, 'main-search-input')">
                     <button onclick="handleSearch(null, 'main-search-input', true)" class="absolute right-16 top-1/2 transform -translate-y-1/2 text-shinhan-blue hover:text-shinhan-dark-blue transition-colors p-2 z-10">
                        <i class="fas fa-arrow-right text-xl"></i> 
                    </button>
                    <button onclick="startSpeechRecognition('main-search-input')" class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col items-center text-shinhan-blue hover:text-shinhan-dark-blue transition-colors z-10">
                        <i class="fas fa-microphone text-xl"></i>
                        <span class="text-xs mt-0.5">ë§í•˜ê¸°</span>
                    </button>
                </div>
            </div>
            <div class="p-4 space-y-3">
                <h2 class="text-lg font-semibold text-shinhan-dark-gray mb-3 px-2">ì¶”ì²œ ì„œë¹„ìŠ¤</h2>
                <div onclick="showPage('page-balance')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ’° ì”ì•¡ì¡°íšŒ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="goToTransferFromMainUI()" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ’¸ ì†¡ê¸ˆ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="goToSolBotWithQuery('ì‹ í•œì€í–‰ íˆ¬ì ìƒí’ˆ ì¶”ì²œí•´ì¤˜')" class="bg-gray-100 hover:bg-gray-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all">
                    <span class="text-shinhan-dark-gray text-md">ğŸ“ˆ íˆ¬ì ì¶”ì²œ</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
                <div onclick="getFinancialTip()" class="bg-shinhan-light-blue hover:bg-blue-200 p-4 rounded-xl shadow flex justify-between items-center cursor-pointer transition-all mt-4">
                    <span class="text-shinhan-blue font-semibold text-md">âœ¨ ì˜¤ëŠ˜ì˜ AI ê¸ˆìœµ íŒ</span>
                    <i class="fas fa-lightbulb text-shinhan-blue"></i>
                </div>
            </div>
             <div class="text-center mt-8">
                 <button onclick="showPage('page-chat')" class="inline-flex items-center justify-center bg-shinhan-blue text-white font-bold py-3 px-8 rounded-full transition-colors duration-300 shadow-lg">
                    <i class="fas fa-robot mr-2"></i><span>SOLë´‡ê³¼ ëŒ€í™”í•˜ê¸°</span>
                </button>
             </div>
        </div>
        
        <!-- Page 3: Balance Inquiry -->
        <div id="page-balance" class="page bg-shinhan-gray">
            <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                <button onclick="showPage('page-main')" class="text-shinhan-blue mr-3">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-xl font-semibold text-shinhan-dark-gray">ê³„ì¢Œ ì”ì•¡ ì¡°íšŒ</h2>
            </div>
            <div id="balance-list-container" class="p-4 space-y-4">
                <!-- Balance list will be rendered here -->
            </div>
        </div>

        <!-- Page 4: SOLbot Chat -->
        <div id="page-chat" class="page bg-gray-100">
            <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                <button onclick="showPage('page-main')" class="text-shinhan-blue mr-3">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                    <i class="fas fa-robot"></i>
                </div>
                <h2 class="text-xl font-semibold text-shinhan-dark-gray">SOLë´‡</h2>
            </div>
            <div id="chat-messages-container" class="no-scrollbar">
                <div id="chat-messages" class="p-4 space-y-4"> 
                </div>
            </div>
            <div id="solbot-input-container" class="flex-shrink-0"> 
                <div class="flex items-center bg-gray-100 rounded-full p-1">
                    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë§í•´ì£¼ì„¸ìš”" class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500" onkeypress="handleChatInput(event)">
                    <button onclick="startSpeechRecognition('chat-input')" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors">
                        <i class="fas fa-microphone text-xl"></i>
                    </button>
                     <button onclick="sendChatMessage(document.getElementById('chat-input').value, false)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </div>
        </div>


        <!-- Page 5: Transfer (ì±„íŒ…í˜• ì†¡ê¸ˆ) -->
        <div id="page-transfer" class="page bg-gray-100"> 
            <div class="w-full h-full bg-gray-100 z-20 flex flex-col"> 
                <div class="bg-white p-3 flex items-center sticky top-0 z-10 border-b shadow-sm flex-shrink-0">
                    <button onclick="cancelTransferAndGoBack()" class="text-shinhan-blue mr-3">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div class="w-10 h-10 bg-shinhan-blue rounded-full flex items-center justify-center text-white text-xl mr-3">
                        <i class="fas fa-comments-dollar"></i> 
                    </div>
                    <h2 class="text-xl font-semibold text-shinhan-dark-gray">ì†¡ê¸ˆí•˜ê¸°</h2>
                </div>
                <div id="transfer-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto no-scrollbar">
                </div>
                 <div id="transfer-summary-display" class="p-4 bg-white border-t flex-shrink-0" style="display:none;">
                    <h3 class="text-md font-semibold text-shinhan-dark-gray mb-2 text-center">âœ¨ ì´ì²´ ê²°ê³¼ âœ¨</h3>
                    <div id="ai-transfer-summary-text" class="bg-shinhan-light-blue text-shinhan-dark-gray p-3 rounded-lg shadow text-sm mb-3 text-left">
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="startTransferChat(true)" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">
                           ìƒˆë¡œìš´ ì†¡ê¸ˆ
                        </button>
                        <button onclick="goToSolBotFromTransfer()" class="w-1/2 bg-shinhan-blue hover:bg-shinhan-dark-blue text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">
                           SOLë´‡ê³¼ ëŒ€í™”í•˜ê¸°
                        </button>
                    </div>
                </div>
                <div id="transfer-input-area" class="bg-white p-3 border-t flex-shrink-0"> 
                    <div class="flex items-center bg-gray-100 rounded-full p-1">
                        <input type="text" id="transfer-chat-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." class="flex-grow bg-transparent p-3 focus:outline-none text-shinhan-dark-gray placeholder-gray-500">
                        <button onclick="handleTransferChatInput(true)" class="text-shinhan-blue p-3 rounded-full hover:bg-gray-200 transition-colors ml-1">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </button>
                    </div>
                     <div id="transfer-quick-reply-area" class="flex flex-col items-center mt-2">
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <div id="toast-message" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        ë©”ì‹œì§€ ë‚´ìš©
    </div>

    <script>
        let currentPage = 'page-cover';
        let previousPageForTransfer = 'page-main';
        let initialSolbotQuery = null;
        let initialTransferData = null;
        
        const GEMINI_API_KEY = "AIzaSyCPgXe1ZIxIa6aJp_l9Jxn5dnO8XhUcOig"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        let currentTransferStep = ''; 
        const availableAccounts = [ 
            { name: "ì‹ í•œ ì£¼ê±°ë˜ ìš°ëŒ€í†µì¥", number: "110-***-123456", balance: 2500000 },
            { name: "ì í¸í•œ ì…ì¶œê¸ˆí†µì¥", number: "123-***-789012", balance: 150000 }
        ];
        let transferData = { 
            recipient: '', 
            amount: '', 
            account: availableAccounts[0].name, 
        };

        const SHINHAN_BOT_PERSONA = "ë‹¹ì‹ ì€ ì‹ í•œì€í–‰ì˜ AI ê¸ˆìœµ ë¹„ì„œ 'SOLë´‡'ì…ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì€ ì‹ í•œì€í–‰ì˜ ì…ì¥ì—ì„œ ê¸ˆìœµê³¼ ê´€ë ¨ëœ ë‚´ìš©ìœ¼ë¡œ, ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤. ";

        async function callGeminiAPI(prompt) {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            
            const fullPrompt = SHINHAN_BOT_PERSONA + prompt;
            let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    return "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ë‹µë³€ì„ ë“œë¦¬ê¸° ì–´ë µë„¤ìš”.";
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:", result);
                    return "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ë‹µë³€ì„ ë“œë¦¬ê¸° ì–´ë µë„¤ìš”.";
                }
            } catch (error) {
                console.error('Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                showToast(`ì˜¤ë¥˜: ${error.message.substring(0,100)}`); 
                return "ì£„ì†¡í•´ìš”, ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.";
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            
            if (target) {
                target.classList.add('active');
                currentPage = pageId; 

                if (pageId === 'page-transfer') {
                    if(initialTransferData) {
                        presentOneStepTransfer(initialTransferData);
                        initialTransferData = null;
                    } else {
                        startTransferChat(); 
                    }
                } else if (pageId === 'page-chat') {
                    initializeSolbotChat();
                } else if (pageId === 'page-balance') {
                    renderBalanceList();
                }
            }
        }
        
        function initializeSolbotChat() {
            const chatMessagesArea = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            if (chatMessagesArea) {
                 chatMessagesArea.innerHTML = ''; 
                 addMessageToChat("AI", "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì‹ í•œì€í–‰ AI ë¹„ì„œ SOLë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.", 'chat-messages', 'chat-bubble-bot');
            }
            if(chatInput) {
                chatInput.disabled = false;
                chatInput.focus();
            }
            if (initialSolbotQuery) {
                sendChatMessage(initialSolbotQuery, false, true); 
                initialSolbotQuery = null; 
            }
        }
        
        function renderBalanceList() {
            const container = document.getElementById('balance-list-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous list

            let totalBalance = 0;
            availableAccounts.forEach(acc => {
                totalBalance += acc.balance;
                const accountCard = `
                    <div class="bg-white p-4 rounded-xl shadow mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold text-shinhan-dark-gray">${escapeHTML(acc.name)}</div>
                            <div class="text-xs text-gray-500">${escapeHTML(acc.number)}</div>
                        </div>
                        <div class="text-right text-2xl font-bold text-shinhan-dark-gray">${acc.balance.toLocaleString()} ì›</div>
                    </div>
                `;
                container.innerHTML += accountCard;
            });

            const totalBalanceCard = `
                <div class="bg-shinhan-blue text-white p-5 rounded-xl shadow-lg mb-6">
                    <div class="text-sm opacity-80">ì´ ì”ì•¡</div>
                    <div class="text-3xl font-bold mt-1">${totalBalance.toLocaleString()} ì›</div>
                </div>
            `;
            container.innerHTML = totalBalanceCard + container.innerHTML;
        }

        function parseTransferQuery(query) {
            const pattern = /(.+?)(ì—ê²Œ)?\s*([\d,]+)ë§Œ?\s*ì›\s*(ë³´ë‚´ì¤˜|ì†¡ê¸ˆ|ì´ì²´)/;
            let match = query.match(pattern);
            
            if (match) {
                let recipient = match[1].trim();
                let amountStr = match[3].replace(/,/g, '');
                let amount = parseFloat(amountStr);

                if (query.includes('ë§Œì›') && !query.includes('ë§Œ ì›')) {
                    amount *= 10000;
                }
                
                if (recipient && amount) {
                    return { recipient, amount };
                }
            }
            return null;
        }

        function handleSearch(event, inputId, isSearchIcon = false) {
            const input = document.getElementById(inputId);
            const query = input ? input.value.trim() : "";
            let executeAction = false;

            if ((event && event.key === 'Enter' && query) || (isSearchIcon && query)) {
                executeAction = true;
            } else if ((event && event.key === 'Enter' && !query) || (isSearchIcon && !query)) {
                showToast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if(executeAction) {
                const parsedData = parseTransferQuery(query);
                if (parsedData) {
                    showToast(`'${escapeHTML(query)}' ìš”ì²­ í™•ì¸. ì†¡ê¸ˆ í™•ì¸ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                    previousPageForTransfer = currentPage;
                    initialTransferData = parsedData;
                    setTimeout(() => { showPage('page-transfer'); if(input) input.value = ""; }, 300);
                } else {
                    showToast(`'${escapeHTML(query)}'ì— ëŒ€í•´ SOLë´‡ì—ê²Œ ë¬¼ì–´ë³¼ê²Œìš”.`);
                    initialSolbotQuery = query;
                    setTimeout(() => { showPage('page-chat'); if(input) input.value = ""; }, 300);
                }
            }
        }
        
        async function getFinancialTip() {
            showToast("âœ¨ AIê°€ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ íŒì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...");
            const prompt = "20ëŒ€ ì‚¬íšŒì´ˆë…„ìƒì„ ìœ„í•œ ì‹¤ìš©ì ì¸ ê¸ˆìœµ íŒ í•˜ë‚˜ë¥¼ ì•Œë ¤ì¤˜.";
            const tip = await callGeminiAPI(prompt);
            showToast(marked.parse(tip), 5000); 
        }

        function goToTransferFromMainUI() { 
            previousPageForTransfer = 'page-main';
            initialTransferData = null; // Ensure step-by-step
            showPage('page-transfer'); 
        }

        function goToSolBotWithQuery(query) {
            initialSolbotQuery = query;
            showPage('page-chat');
        }

        function handleChatInput(event) { if (event.key === 'Enter') { sendChatMessage(document.getElementById('chat-input').value, false); } }
        
        async function sendChatMessage(message, isInitialQuery = false) { 
            const chatInput = document.getElementById('chat-input'); 
            const messageText = (typeof message === 'string' ? message.trim() : (chatInput ? chatInput.value.trim() : ""));
            let userPrompt = messageText;
            
            if (!userPrompt) {
                 if(!isInitialQuery) showToast("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const lowerUserPrompt = userPrompt.toLowerCase();
            const balanceKeywords = ["ì”ì•¡", "ì”ê³ ", "í†µì¥ ë³´ì—¬ì¤˜", "ì–¼ë§ˆ ìˆì–´", "ëˆ ì–¼ë§ˆë‚¨ì•˜ì–´", "ëˆ ì–¼ë§ˆë‚˜ìˆì–´"];
            
            if (balanceKeywords.some(kw => lowerUserPrompt.includes(kw))) {
                 addMessageToChat("user", userPrompt, 'chat-messages', 'chat-bubble-user');
                 setTimeout(() => {
                    addMessageToChat("AI", "ë„¤, ê³„ì¢Œ ì”ì•¡ì„ ì¡°íšŒí•´ ë“œë¦´ê²Œìš”. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.", 'chat-messages', 'chat-bubble-bot');
                 }, 300);
                 setTimeout(() => {
                    showPage('page-balance');
                 }, 1200);
                 if(chatInput) chatInput.value = '';
                 return;
            }
            
            if (lowerUserPrompt.includes("ì†¡ê¸ˆ") || lowerUserPrompt.includes("ë³´ë‚´ì¤˜") || lowerUserPrompt.includes("ì´ì²´")) {
                 const parsedData = parseTransferQuery(userPrompt);
                 addMessageToChat("user", userPrompt, 'chat-messages', 'chat-bubble-user');
                 setTimeout(() => {
                    addMessageToChat("AI", "ë„¤, ì†¡ê¸ˆí•˜ì‹œë ¤ëŠ”êµ°ìš”. ì†¡ê¸ˆ í™”ë©´ìœ¼ë¡œ ì•ˆë‚´í•´ ë“œë¦´ê²Œìš”.", 'chat-messages', 'chat-bubble-bot');
                 }, 300);
                 setTimeout(() => {
                    previousPageForTransfer = 'page-chat';
                    initialTransferData = parsedData;
                    showPage('page-transfer');
                 }, 1200);
                 if(chatInput) chatInput.value = '';
                 return;
            }

            addMessageToChat("user", userPrompt, 'chat-messages', 'chat-bubble-user');
            if(chatInput) chatInput.value = '';
            if(chatInput) chatInput.disabled = true;

            const aiResponseText = await callGeminiAPI(userPrompt); 
            addMessageToChat("AI", aiResponseText, 'chat-messages', 'chat-bubble-bot');

            if(chatInput) {
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        function addMessageToChat(sender, text, messageAreaId, bubbleClass) {
            const messagesArea = document.getElementById(messageAreaId);
            if(!messagesArea) return; 
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full`; 
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-lg shadow chat-bubble ${bubbleClass}`;
            
            if (sender === 'AI' && typeof marked !== 'undefined' && text) { bubbleDiv.innerHTML = marked.parse(text); } 
            else if (text) { bubbleDiv.innerHTML = text; } // Allow HTML from system messages
            else { bubbleDiv.textContent = ""; }
            
            messageDiv.appendChild(bubbleDiv);
            messagesArea.appendChild(messageDiv);
            const container = messagesArea.parentElement;
            container.scrollTop = container.scrollHeight;
        }
        
        // --- Transfer Chat Functions ---
        function presentOneStepTransfer(data) {
            const chatArea = document.getElementById('transfer-chat-messages');
            if (chatArea) chatArea.innerHTML = '';
            document.getElementById('transfer-summary-display').style.display = 'none';
            document.getElementById('transfer-input-area').style.display = 'block';
            document.getElementById('transfer-chat-input').disabled = true;
            
            transferData = { ...transferData, ...data }; 
            currentTransferStep = 'confirm';
            const confirmMsg = `<strong>${escapeHTML(transferData.recipient)}</strong>ë‹˜ì—ê²Œ <strong>${escapeHTML(transferData.amount.toLocaleString())}ì›</strong>ì„ ì´ì²´í• ê¹Œìš”?`;
            addMessageToChat('bot', confirmMsg, 'transfer-chat-messages', 'chat-bubble-bot');
            showConfirmationQuickReplies('transfer-quick-reply-area', 'âœ… ì†¡ê¸ˆ ì‹¤í–‰', 'âŒ ì·¨ì†Œ', processTransferStep, true); // show account selector
        }

        function startTransferChat(isReset = false){
            if(isReset) {
                showToast("ìƒˆë¡œìš´ ì†¡ê¸ˆì„ ì‹œì‘í•©ë‹ˆë‹¤.");
            }
            document.getElementById('transfer-chat-messages').innerHTML = ''; 
            document.getElementById('transfer-summary-display').style.display = 'none'; 
            document.getElementById('transfer-input-area').style.display = 'block'; 
            document.getElementById('transfer-chat-input').disabled = false;
            transferData = { recipient: '', amount: '', account: availableAccounts[0].name }; 
            currentTransferStep = 'recipient';
            addMessageToChat('bot', 'ëˆ„êµ¬ì—ê²Œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ? ê³„ì¢Œë²ˆí˜¸ë‚˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'transfer-chat-messages', 'chat-bubble-bot');
            clearQuickReplies('transfer-quick-reply-area'); 
            document.getElementById('transfer-chat-input').placeholder = 'ë°›ëŠ” ë¶„ ì…ë ¥...'; 
            document.getElementById('transfer-chat-input').type = 'text';
        }
        function handleTransferChatInput(isSendButton = false, quickReplyValue = null){
            const input = document.getElementById('transfer-chat-input');
            const userText = quickReplyValue !== null ? quickReplyValue : (input ? input.value.trim() : "");
            if (!userText) { showToast("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            addMessageToChat('user', userText, 'transfer-chat-messages', 'chat-bubble-user');
            if(input) input.value = '';
            clearQuickReplies('transfer-quick-reply-area'); 
            setTimeout(() => processTransferStep(userText), 300);
        }
        function processTransferStep(userData){
             switch(currentTransferStep) {
                case 'recipient':
                    transferData.recipient = userData; currentTransferStep = 'amount';
                    addMessageToChat('bot', `ë„¤, ${escapeHTML(transferData.recipient)}ë‹˜ì—ê²Œ ë³´ë‚´ì‹œëŠ”êµ°ìš”. ì–¼ë§ˆë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`, 'transfer-chat-messages', 'chat-bubble-bot');
                    document.getElementById('transfer-chat-input').type = 'number'; document.getElementById('transfer-chat-input').placeholder = 'ê¸ˆì•¡(ìˆ«ì) ì…ë ¥...';
                    break;
                case 'amount':
                    if (!isNaN(parseFloat(userData)) && isFinite(userData) && parseFloat(userData) > 0) {
                        transferData.amount = parseFloat(userData); currentTransferStep = 'account';
                        addMessageToChat('bot', `${escapeHTML(transferData.amount.toLocaleString())}ì›ì„ ë³´ë‚´ì‹œëŠ”êµ°ìš”. ì–´ë–¤ ê³„ì¢Œì—ì„œ ì¶œê¸ˆí• ê¹Œìš”?`, 'transfer-chat-messages', 'chat-bubble-bot');
                        document.getElementById('transfer-chat-input').type = 'text'; document.getElementById('transfer-chat-input').placeholder = 'ê³„ì¢Œ ë³„ì¹­ ë˜ëŠ” ì„ íƒ...';
                        showAccountQuickReplies();
                    } else { addMessageToChat('bot', 'ê¸ˆì•¡ì€ 0ë³´ë‹¤ í° ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'transfer-chat-messages', 'chat-bubble-bot'); }
                    break;
                case 'account':
                    transferData.account = userData; currentTransferStep = 'confirm';
                    const confirmMsg = `ì•Œê² ìŠµë‹ˆë‹¤! <strong>${escapeHTML(transferData.recipient)}</strong>ë‹˜ì—ê²Œ <strong>${escapeHTML(transferData.amount.toLocaleString())}ì›</strong>ì„ ì´ì²´í• ê¹Œìš”?`;
                    addMessageToChat('bot', confirmMsg, 'transfer-chat-messages', 'chat-bubble-bot');
                    showConfirmationQuickReplies('transfer-quick-reply-area', 'âœ… ì†¡ê¸ˆ ì‹¤í–‰', 'âŒ ì·¨ì†Œ', processTransferStep, true); // show account selector
                    document.getElementById('transfer-chat-input').disabled = true; 
                    break;
                case 'confirm': 
                    if (userData.toLowerCase().includes('ì‹¤í–‰')) executeTransferViaChat();
                    else { addMessageToChat('bot', 'ì†¡ê¸ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'transfer-chat-messages', 'chat-bubble-bot'); setTimeout(cancelTransferAndGoBack, 1500); }
                    break;
            }
        }
        function showAccountQuickReplies(){
            const area = document.getElementById('transfer-quick-reply-area');
            area.innerHTML = ''; 
            availableAccounts.forEach(acc => {
                const button = document.createElement('button'); button.className = 'quick-reply-button';
                button.textContent = acc.name; button.onclick = () => handleTransferChatInput(false, acc.name); 
                area.appendChild(button);
            });
        }
        function showConfirmationQuickReplies(areaId, confirmText, cancelText, callback, showAccountSelect = false){
            const area = document.getElementById(areaId);
            area.innerHTML = '';

            if(showAccountSelect) {
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = 'ì¶œê¸ˆ ê³„ì¢Œ ì„ íƒ:';
                area.appendChild(label);

                const selectEl = document.createElement('select');
                selectEl.id = 'bottom-account-select';
                selectEl.innerHTML = availableAccounts.map(acc => `<option value="${acc.name}" ${acc.name === transferData.account ? 'selected' : ''}>${acc.name} (ì”ì•¡: ${acc.balance.toLocaleString()}ì›)</option>`).join('');
                area.appendChild(selectEl);
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-center items-center w-full space-x-2 mt-2';
            
            const confirmButton = document.createElement('button');
            confirmButton.className = 'quick-reply-button bg-shinhan-blue text-white';
            confirmButton.textContent = confirmText;
            confirmButton.onclick = () => { clearQuickReplies(areaId); callback(confirmText); };
            buttonContainer.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.className = 'quick-reply-button bg-gray-400 text-white';
            cancelButton.textContent = cancelText;
            cancelButton.onclick = () => { clearQuickReplies(areaId); callback(cancelText); };
            buttonContainer.appendChild(cancelButton);

            area.appendChild(buttonContainer);
        }

        function clearQuickReplies(areaId) {
            const area = document.getElementById(areaId);
            if(area) area.innerHTML = '';
        }
        async function executeTransferViaChat(){
            const finalAccountSelect = document.getElementById('bottom-account-select');
            if (finalAccountSelect) {
                transferData.account = finalAccountSelect.value;
            }
            
            const selectedAccount = availableAccounts.find(acc => acc.name === transferData.account);
            if(!selectedAccount || selectedAccount.balance < transferData.amount) {
                addMessageToChat('bot', 'ì„ íƒí•˜ì‹  ê³„ì¢Œì˜ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ê³„ì¢Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'transfer-chat-messages', 'chat-bubble-bot');
                showConfirmationQuickReplies('transfer-quick-reply-area', 'âœ… ì†¡ê¸ˆ ì‹¤í–‰', 'âŒ ì·¨ì†Œ', processTransferStep, true);
                return;
            }

            document.getElementById('transfer-input-area').style.display = 'none'; 
            
            const newBalance = selectedAccount.balance - transferData.amount;
            
            addMessageToChat('bot', 'ì´ì²´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'transfer-chat-messages', 'chat-bubble-bot');
            setTimeout(() => { 
                document.getElementById('transfer-summary-display').style.display = 'block'; 
                const summaryDiv = document.getElementById('ai-transfer-summary-text');
                let structuredSummaryHtml = `
                    <p><strong>ë°›ëŠ”ì‚¬ëŒ :</strong> ${escapeHTML(transferData.recipient)}</p>
                    <p><strong>ê¸ˆì•¡ :</strong> ${escapeHTML(transferData.amount.toLocaleString())} ì›</p>
                    <p><strong>ì¶œê¸ˆí†µì¥ :</strong> ${escapeHTML(transferData.account)}</p>
                    <hr class="my-2 border-gray-300">
                    <p><strong>ì¶œê¸ˆ í›„ ì”ì•¡ :</strong> ${escapeHTML(newBalance.toLocaleString())} ì›</p>`;
                summaryDiv.innerHTML = structuredSummaryHtml;
                selectedAccount.balance = newBalance;
            }, 500);
        }
        function goToSolBotFromTransfer(){
            initialSolbotQuery = `${transferData.recipient}ë‹˜ì—ê²Œ ì†¡ê¸ˆí•œ ë‚´ì—­ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³  ì‹¶ì–´ìš”.`;
            showPage('page-chat');
        }
        function cancelTransferAndGoBack(){ showToast("ì†¡ê¸ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); showPage(previousPageForTransfer || 'page-main');}

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }
        let toastTimeout;
        function showToast(message, duration = 2500) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;
            if (typeof message === 'string' && (message.includes('<') || message.includes('&'))) toast.innerHTML = message; 
            else toast.textContent = message;
            toast.style.opacity = '1';
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.style.opacity = '0'; }, duration);
        }
        
        // --- Speech Recognition ---
        function startSpeechRecognition(inputId) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast("ì£„ì†¡í•˜ì§€ë§Œ, ì‚¬ìš©í•˜ì‹œëŠ” ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                showToast("ğŸ¤ ë“£ê³  ìˆì–´ìš”... ë§ì”€í•´ì£¼ì„¸ìš”.");
            };

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const targetInput = document.getElementById(inputId);
                if (targetInput) {
                    targetInput.value = speechResult;
                    showToast(`ì¸ì‹ëœ ë‚´ìš©: "${speechResult}"`);
                    // Automatically trigger action based on inputId
                    if (inputId === 'chat-input') {
                        setTimeout(() => sendChatMessage(speechResult), 300);
                    } else {
                        setTimeout(() => handleSearch(null, inputId, true), 500);
                    }
                }
            };

            recognition.onspeechend = () => {
                recognition.stop();
            };

            recognition.onerror = (event) => {
                if (event.error == 'no-speech') {
                    showToast("ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } else if (event.error == 'audio-capture') {
                    showToast("ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë§ˆì´í¬ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                } else if (event.error == 'not-allowed') {
                    showToast("ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                } else {
                    showToast("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error("Speech recognition error:", event.error);
                }
            };
            
            recognition.start();
        }

        document.addEventListener('DOMContentLoaded', () => {
            showPage('page-cover'); 
            document.getElementById('transfer-chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') handleTransferChatInput(true); });
        });
    </script>
</body>
</html>
